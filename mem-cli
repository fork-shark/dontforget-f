#!/bin/bash

# --- CONFIGURATION ---
if [ -z "$DONTFORGET_API_URL" ]; then
    echo -e "\033[0;31mError: DONTFORGET_API_URL is not set.\033[0m"
    exit 1
fi

if [ -z "$DONTFORGET_SECRET_KEY" ]; then
    echo -e "\033[0;31mError: DONTFORGET_SECRET_KEY is not set.\033[0m"
    exit 1
fi
API_URL="$DONTFORGET_API_URL"
API_KEY="$DONTFORGET_SECRET_KEY"

# --- COLORS ---
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- LOGIC ---
COMMAND=$1
INPUT=$2

case $COMMAND in
    remember|save|r)
        if [ -z "$INPUT" ]; then
            TEMP_FILE=$(mktemp)
            ${EDITOR:-vim} "$TEMP_FILE"
            CONTENT=$(cat "$TEMP_FILE")
            rm "$TEMP_FILE"
            if [ -z "$CONTENT" ]; then echo -e "${RED}Aborted.${NC}"; exit 1; fi
        else
            CONTENT="$INPUT"
        fi
        
        echo -e "${BLUE}ðŸ§  Saving...${NC}"
        # Safe JSON creation
        JSON_PAYLOAD=$(python3 -c "import json; print(json.dumps({'text': '''$CONTENT'''}))")
        
        RESPONSE=$(curl -s -X POST "$API_URL/remember" \
            -H "x-api-key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
        
        STATUS=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('status', 'error'))" 2>/dev/null)
        
        if [ "$STATUS" == "saved" ]; then
            # Parse list of tags
            TAGS=$(echo "$RESPONSE" | python3 -c "import sys, json; print(', '.join(json.load(sys.stdin).get('tags', [])))" 2>/dev/null)
            echo -e "${GREEN}âœ” Saved!${NC}"
            echo -e "${YELLOW}Tags:${NC} $TAGS"
        else
            echo -e "${RED}âœ˜ Error:${NC} $RESPONSE"
        fi
        ;;

    ask|remind|q)
        if [ -z "$INPUT" ]; then echo -e "${RED}Missing query.${NC}"; exit 1; fi
        echo -e "${BLUE}ðŸ” Thinking...${NC}"
        
        JSON_PAYLOAD=$(python3 -c "import json; print(json.dumps({'question': '''$INPUT'''}))")
        
        RESPONSE=$(curl -s -X POST "$API_URL/remind" \
            -H "x-api-key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

        ANSWER=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('answer', 'Server Error'))" 2>/dev/null)
        STATS=$(echo "$RESPONSE" | python3 -c "import sys, json; d=json.load(sys.stdin).get('stats', {}); print(f'{d.get(\"found\",0)} records | {d.get(\"tokens\",0)} tokens')" 2>/dev/null)
        
        echo -e "\n${GREEN}$ANSWER${NC}\n"
        echo -e "${BLUE}--------------------------------${NC}"
        echo -e "${YELLOW}ðŸ“Š Stats: $STATS${NC}\n"
        ;;
    
    delete|d)
        if [ -z "$INPUT" ]; then echo -e "${RED}Missing query.${NC}"; exit 1; fi
        
        JSON_PAYLOAD=$(python3 -c "import json; print(json.dumps({'question': '''$INPUT'''}))")
        RESPONSE=$(curl -s -X POST "$API_URL/delete" \
            -H "x-api-key: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")
        
        ANSWER=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('answer', 'Error'))" 2>/dev/null)
        echo -e "\n${GREEN}$ANSWER${NC}\n"
        ;;
        
    *)
        echo "Usage: mem [r|q|d] [text]"
        exit 1
        ;;
esac
